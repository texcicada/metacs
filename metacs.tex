\documentclass{article}
\usepackage[table]{xcolor}
\usepackage{xparse}
\usepackage{fontspec}
\newfontfamily\fcmu{CMU Serif}
\newcommand\mytheadcolour{blue!15}
\usepackage{abstract}
\newcommand\ack{{\noindent *{\small\textsc{Acknowledgements}: }{\scriptsize Macro names \codedetok{\marg}, \codedetok{\oarg} and \codedetok{\meta} from ltxdoc, and \codegeneral{latexcode} environment from doctools package. All latex coding inspiration in this document derives ultimately from hundreds of contributions on tex stackexchange, and from package authors and maintainers over the decades.}}}
\usepackage{paralist}
%tb
%uc
%vd
%\usepackage{doctools}

\newcommand\myrulesep{%
\bigskip
\begin{center}
\rule{0.35\textwidth}{0.2pt}
\end{center}
\vspace{2em}
}



\ExplSyntaxOn
\tl_new:N \l_my_tl
\tl_new:N \l_myb_tl
\tl_new:N \l_myc_tl
%\tl_new:N \l_left_brace_tl
%\tl_set:Nn \l_left_brace_tl { { }
%\tl_new:N \l_right_brace_tl
%\tl_set:Nn \l_right_brace_tl { { }





%-------------------------- formats
%----- marg
\NewDocumentCommand{\csmetaformat} { } {
      \cc{itshape}
     	\cc{fcmu}
}


%----- marg
\NewDocumentCommand{\margdelimformat} { } {
																			\ttfamily\large\color{red}
}
%----- marg left format
\NewDocumentCommand{\margdelimleftformat} { } {
																			\margdelimformat
}
%----- marg left char
\NewDocumentCommand{\margdelimleftchar} { } {
																		  \c_left_brace_str
}
%----- marg left
\NewDocumentCommand{\margdelimleft} { } {
																			{ 
																			\margdelimleftformat
																		  \margdelimleftchar
																		  }
}
%----- marg left reset ========================
\NewDocumentCommand{\margdelimleftreset} { } {
		
\RenewDocumentCommand{\margdelimformat} { } {
		\ttfamily\large\color{red}
	}
\RenewDocumentCommand{\margdelimleftformat} { } {
																			\margdelimformat
}
%----- marg left char
\RenewDocumentCommand{\margdelimleftchar} { } {
																		  \c_left_brace_str
}
%----- marg left
\RenewDocumentCommand{\margdelimleft} { } {
																			{ 
																			\margdelimleftformat
																		  \margdelimleftchar
																		  }
}
		
}
%----- marg right reset
\NewDocumentCommand{\margdelimrightreset} { } {
		
\RenewDocumentCommand{\margdelimformat} { } {
		\ttfamily\large\color{red}
	}
\RenewDocumentCommand{\margdelimrightformat} { } {
																			\margdelimformat
}
%----- marg right char
\RenewDocumentCommand{\margdelimrightchar} { } {
																		  \c_right_brace_str
}
%----- marg right
\RenewDocumentCommand{\margdelimright} { } {
																			{ 
																			\margdelimrightformat
																		  \margdelimrightchar
																		  }
}
		
}

%
\NewDocumentCommand{\margreset} { } {
		\margdelimleftreset
		\margdelimrightreset		
}




%----- marg right format
\NewDocumentCommand{\margdelimrightformat} { } {
																			\margdelimformat
}
%----- marg right char
\NewDocumentCommand{\margdelimrightchar} { } {
																		  \c_right_brace_str
}
%----- marg right
\NewDocumentCommand{\margdelimright} { } {
																			{ 
																			\margdelimrightformat
																		  \margdelimrightchar
																		  }
}


%----- oarg left reset ========================
\NewDocumentCommand{\oargdelimleftreset} { } {
		
\RenewDocumentCommand{\oargdelimformat} { } {
																			\ttfamily\large
	}
\RenewDocumentCommand{\oargdelimleftformat} { } {
																			\oargdelimformat
}
%----- oarg left char
\RenewDocumentCommand{\oargdelimleftchar} { } {
																		  [
}
%----- oarg left
\RenewDocumentCommand{\oargdelimleft} { } {
																			{ 
																			\oargdelimleftformat
																		  \oargdelimleftchar
																		  }
}
		
}
%----- oarg right reset
\NewDocumentCommand{\oargdelimrightreset} { } {
		
\RenewDocumentCommand{\oargdelimformat} { } {
																			\ttfamily\large
	}
\RenewDocumentCommand{\oargdelimrightformat} { } {
																			\oargdelimformat
}
%----- oarg right char
\RenewDocumentCommand{\oargdelimrightchar} { } {
																		  ]
}
%----- oarg right
\RenewDocumentCommand{\oargdelimright} { } {
																			{ 
																			\oargdelimrightformat
																		  \oargdelimrightchar
																		  }
}
		
}

%
\NewDocumentCommand{\oargreset} { } {
		\oargdelimleftreset
		\oargdelimrightreset		
}




%----- oarg
\NewDocumentCommand{\oargdelimformat} { } {
																			\ttfamily\large
}
%----- oarg left format
\NewDocumentCommand{\oargdelimleftformat} { } {
																			\oargdelimformat
}
%----- oarg left char
\NewDocumentCommand{\oargdelimleftchar} { } {
																		  [
}
%----- oarg left
\NewDocumentCommand{\oargdelimleft} { } {
																			{ 
																			\oargdelimleftformat
																		  \oargdelimleftchar
																		  }
}
%----- oarg right format
\NewDocumentCommand{\oargdelimrightformat} { } {
																			\oargdelimformat
}
%----- oarg right char
\NewDocumentCommand{\oargdelimrightchar} { } {
																		  ]
}
%----- oarg right
\NewDocumentCommand{\oargdelimright} { } {
																			{ 
																			\oargdelimrightformat
																		  \oargdelimrightchar
																		  }
}












%------------------------------- control sequence
\NewDocumentCommand{\cs}{ m }{%
  {\bfseries\sffamily\color{blue}
  \token_to_str:N #1 % If you already have a token
  }
}%




%------------------------------- print full meta
\NewDocumentCommand{\mcs}{ m m m m m }{% css (o|m)argcss
%the meta
%{ \ttfamily
\css{#1}
\tl_set:Nn \l_my_tl { #2 }
\tl_if_empty:NTF  \l_my_tl  {  } { \oargcss{#2} }
\tl_set:Nn \l_my_tl { #3 }
\tl_if_empty:NTF  \l_my_tl {  } { \margcss{#3} }
\tl_set:Nn \l_my_tl { #4 }
\tl_if_empty:NTF  \l_my_tl {  } { \margcss{#4} }
\tl_set:Nn \l_my_tl { #5 }
\tl_if_empty:NTF  \l_my_tl {  } { \margcss{#5} }
%}
%$\mapsto$
%%the command:
%\tl_set:Nn \l_my_tl { #2 }
%\cs:w #1 \cs_end: 
%								 { \tl_use:N \l_my_tl }
}%






%------------------------------- print full meta value
\NewDocumentCommand{\mcsv}{ m m m m m }{%
%the meta
%{ \ttfamily
\css{#1}
\tl_set:Nn \l_my_tl { #2 }
\tl_if_empty:NTF  \l_my_tl  {  } { \oargvcss{#2} }
\tl_set:Nn \l_my_tl { #3 }
\tl_if_empty:NTF  \l_my_tl {  } { \margvcss{#3} }
\tl_set:Nn \l_my_tl { #4 }
\tl_if_empty:NTF  \l_my_tl {  } { \margvcss{#4} }
\tl_set:Nn \l_my_tl { #5 }
\tl_if_empty:NTF  \l_my_tl {  } { \margvcss{#5} }
%}
%$\mapsto$
%%the command:
%\tl_set:Nn \l_my_tl { #2 }
%\cs:w #1 \cs_end: 
%								 { \tl_use:N \l_my_tl }
}%





%------------------------------- control sequence build
\NewDocumentCommand{\css}{ m }{%
  \token_to_str:c #1 % add \
}%


%------------------------------- mandatory argument
\NewDocumentCommand{\marg}{ m }{%
\tl_set:Nn \l_my_tl { 
%                              {
%                               \ttfamily\large\color{red}
%																		  \c_left_brace_str
%																		  }
																				\margdelimleft
																		  \meta{#1}
																				\margdelimright
%                              {
%                               \ttfamily\large\color{red}
%																		  \c_right_brace_str
%																		   }
																		  }
\tl_use:N \l_my_tl
}%

\providecommand\margf[1]{%
  {\ttfamily\large\color{red}\char`\{}\meta{#1}{\ttfamily\large\color{red}\char`\}}}



%------------------------------- mandatory argument, no format
\NewDocumentCommand{\margcss}{ m }{%
\tl_set:Nn \l_my_tl { 
%                              {
%                               \ttfamily\large\color{red}
																		  \c_left_brace_str
%																		  }
																		  \meta{#1}
%                              {
%                               \ttfamily\large\color{red}
																		  \c_right_brace_str
%																		   }
																		  }
\tl_use:N \l_my_tl
}%




%------------------------------- optional argument
\NewDocumentCommand{\oarg}{ m }{%
\tl_set:Nn \l_my_tl { 
%																		{\ttfamily\large
%																		  [
%																		  }
                             \oargdelimleft
																		  \meta{#1}
																		  \oargdelimright
%																			{\ttfamily\large
%																		  ]
%																		  }
																		 }
\tl_use:N \l_my_tl
}%



%------------------------------- optional argument, no value
\NewDocumentCommand{\oargcss}{ m }{%
\tl_set:Nn \l_my_tl { 
%																		{\ttfamily\large
																		  [
%																		  }
																		  \meta{#1}
%																			{\ttfamily\large
																		  ]
%																		  }
																		 }
\tl_use:N \l_my_tl
}%



%------------------------------- mandatory argument value
\NewDocumentCommand{\margv}{ m }{%
\tl_set:Nn \l_my_tl { 
																				\margdelimleft
																		   #1
																				\margdelimright
																		  }
\tl_use:N \l_my_tl
}%



%------------------------------- mandatory argument value, no format
\NewDocumentCommand{\margvcss}{ m }{%
\tl_set:Nn \l_my_tl { 
%																			{ \ttfamily\large\color{red}
																		  \c_left_brace_str
%																		  }
																		   #1
%																			{ \ttfamily\large\color{red}
																		  \c_right_brace_str
%																		  }
																		  }
\tl_use:N \l_my_tl
}%



%------------------------------- optional argument value
\NewDocumentCommand{\oargv}{ m }{%
\tl_set:Nn \l_my_tl { 
																		 \oargdelimleft
																		  #1
																		 \oargdelimright
																		  }
\tl_use:N \l_my_tl
}%



%------------------------------- optional argument value, no format
\NewDocumentCommand{\oargvcss}{ m }{%
\tl_set:Nn \l_my_tl { 
%																		 {\ttfamily\large 
																		 [ 
%																		 }
																		  #1
%																		 {\ttfamily\large 
																		 ] 
%																		 }
																		  }
\tl_use:N \l_my_tl
}%




%------------------------------- meta left
\NewDocumentCommand{\metaleft}{  }{%
              \cm{\cc{langle}}
              }
%------------------------------- meta right
\NewDocumentCommand{\metaright}{  }{%
              \cm{\cc{rangle}}
              }
%------------------------------- meta
\NewDocumentCommand{\meta}{ m }{%
\tl_set:Nn \l_my_tl { 
             {\cc{large}
              \metaleft
             } 
              	{
              	\csmetaformat
              	#1 
                }
									{ \cc{large}
									\metaright
									}
					}
\tl_use:N \l_my_tl
%%\cs:w bfseries \cs_end: xyz
%%\cs_new:Nn \c: {\cs:w itshape \cs_end:}
%%\cs:w c: \cs_end: qqq
}%


%------------------------------- switch
\NewDocumentCommand{\cc}{ m }{%
%%%\tl_new:N \l_mycc_tl
%%%\tl_set:Nn \l_mycc_tl { \cs:w #1 \cs_end: }
%%%\tl_use:N \l_mycc_tl
%\cs_new:Nn \c: {\cs:w itshape \cs_end:}
%\cs:w c: \cs_end: qqq
\cs:w #1 \cs_end:
}%



%------------------------------- command + argument
\NewDocumentCommand{\cd}{ m m }{%
\tl_set:Nn \l_my_tl { #2 }
\cs:w #1 \cs_end: { \tl_use:N \l_my_tl }
}%





%------------------------------- inline maths
\NewDocumentCommand{\cm}{ m }{%
\tl_set:Nn \l_my_tl { $ #1 $ }
\tl_use:N \l_my_tl
}%


%------------------------------- display maths
\NewDocumentCommand{\cmd}{ m }{%
\tl_set:Nn \l_my_tl { \[ #1 \] }
\tl_use:N \l_my_tl
}%



%------------------------------- demo: command + argument
\NewDocumentCommand{\cssm}{ m m }{%
%the meta
{ \ttfamily
\css{#1}\margvcss{#2} }
$\mapsto$
%the command:
\tl_set:Nn \l_my_tl { #2 }
\cs:w #1 \cs_end: 
								 { \tl_use:N \l_my_tl }
}%


%------------------------------- demo: command + arg + arg
\NewDocumentCommand{\cssmm}{ m m m }{%
%the meta
{ \ttfamily
\css{#1}\margvcss{#2}\margvcss{#3}  }
$\mapsto$
%the command:
\tl_set:Nn \l_my_tl { #2 }
\tl_set:Nn \l_myb_tl { #3 } %2nd argument
\cs:w #1 \cs_end: 
								 { \tl_use:N \l_my_tl }
								 { \tl_use:N \l_myb_tl }
}%


%------------------------------- demo: command + arg + arg + arg
\NewDocumentCommand{\cssmmm}{ m m m m }{%
%the meta
{ \ttfamily
\css{#1}\margvcss{#2}\margvcss{#3}\margvcss{#4}  }
$\mapsto$
%the command:
\tl_set:Nn \l_my_tl { #2 }
\tl_set:Nn \l_myb_tl { #3 } %2nd argument
\tl_set:Nn \l_myc_tl { #4 } %3rd argument
\cs:w #1 \cs_end: 
								 { \tl_use:N \l_my_tl }
								 { \tl_use:N \l_myb_tl }
								 { \tl_use:N \l_myc_tl }
}%

%------------------------------- demo: command + option + argument
\NewDocumentCommand{\cssom}{ m m m }{%
%the meta
{ \ttfamily
	   \css{#1}\oargvcss{#2}\margvcss{#3} }
$\mapsto$
%the command:
\tl_set:Nn \l_my_tl { #3 }
\tl_set:Nn \l_myb_tl { #2 } %option
\cs:w #1 \cs_end: 
									[ \tl_use:N \l_myb_tl ]
								 { \tl_use:N \l_my_tl }
}%

%\tl_new:N \l_my_tl
%\tl_set:Nn \l_my_tl { a b c }
%\cs:w \tl_use:N \l_my_tl \cs_end:
%\cs_set:cpn { some-awkward-1-2-3-name } 

%------------------------------- print and run #1
\NewDocumentCommand{\cdr}{ m }{%
	\tl_set:Nn \l_my_tl { #1 }
	{ \ttfamily\color{blue}
%  \token_to_str:N #1
  \detokenize{#1}
  }
  
  \enspace $\mapsto$ \enspace
  
  \tl_use:N \l_my_tl
}%

%------------------------------- print and run command+argumentt separately
\NewDocumentCommand{\cdpr}{ o m m }{%1=format,2=command,3=argument
	\tl_set:Nn \l_my_tl { #1 }
	\tl_set:Nn \l_myb_tl { #2 }
	\tl_set:Nn \l_myc_tl { #3 }
	{ \ttfamily\color{blue}
%  \token_to_str:N #1
  \detokenize{\tl_use:N \l_myb_tl}
  \{ 
  		\detokenize{\tl_use:N \l_myc_tl}
  \}
  }
  
  \enspace $\mapsto$ \enspace
  
\cs:w \tl_use:N \l_my_tl \cs_end: { { 
									\tl_use:N \l_my_tl % formatting
									\tl_use:N \l_myc_tl % argument
									} }
}%



%------------------------------- display version: print and run #1
\NewDocumentCommand{\cdrq}{ m }{%
	\tl_set:Nn \l_my_tl { #1 }
	\begin{quotation}
	
	{ \ttfamily\color{blue}
%  \token_to_str:N #1
  \detokenize{#1}
  }
  
  \enspace $\mapsto$ \enspace
  
  \tl_use:N \l_my_tl
  
  	\end{quotation}
}%

\tl_new:N  \l_codeformat_tl
\tl_set:Nn \l_codeformat_tl { \cdrdplain }

\keys_define:nn { codef }
 {
  format .choice:,
  format / head   .code:n = \tl_set:Nn \l_codeformat_tl  { \cdrdhead },
  format / custom   .code:n = \tl_set:Nn \l_codeformat_tl  { \cdrdcustom }, %user-code will be second optiom
  format / section   .code:n = \tl_set:Nn \l_codeformat_tl  { \cdrdsection }, 
  format / quote   .code:n = \tl_set:Nn \l_codeformat_tl  { \cdrdquote }, 
  format / listing   .code:n = \tl_set:Nn \l_codeformat_tl  { \cdrdlisting }, 
  format / general   .code:n = \tl_set:Nn \l_codeformat_tl  { \codegeneral }, 
  format / detok   .code:n = \tl_set:Nn \l_codeformat_tl  { \codedetok }, 
   }



%------------------------------- just print #1
\NewDocumentCommand{\cdrd}{ o o m }{%1=key-value,2=format code,3=cs
 
			\IfNoValueTF {#1}
			
			{%true 
			    {
						\ttfamily
					  \color{blue}
					  \large
%					  \colorbox {blue!12} {%header
					  															\detokenize{#3}
%					  																	}
						}
			  }
			{%false 
				{ 
%				  #1
  \group_begin:
  \keys_set:nn { codef } { #1 } 
  \tl_use:N \l_codeformat_tl [ #2 ] { #3 }
  \group_end:

%			  \detokenize{#2}
			  }
			}			  
}%


%------------------------------- just print #1 as header
\NewDocumentCommand{\cdrdhead}{ o m }{%
			{
			    {
						\ttfamily
					  \color{blue}
					  \large
					  \fcolorbox {black} {blue!12} {%header

					  															\detokenize{#2} 
					  																	}
					   \par																	
						}
		}
}%



%------------------------------- just print #1 as plain code
\NewDocumentCommand{\codegeneral}{ o m }{
 
			{%true 
			    {
						\ttfamily
					  															#2
						}
			  }
}%



%------------------------------- just print #1 as plain detok code
\NewDocumentCommand{\codedetok}{ o m }{
 
			{%true 
			    {
						\ttfamily
					  															\detokenize{#2}
						}
			  }
}%




%------------------------------- just print #1 as code
\NewDocumentCommand{\cdrdplain}{ o m }{%option always empty
 
%			\IfNoValueTF {#1}
			{%true 
			    {
						\ttfamily
					  \color{blue}
					  \large
%					  \colorbox {blue!12} {%header
					  															\detokenize{#2}
%					  																	}
						}
			  }
%			{%false : never reached now
%				{ #1
%			  \detokenize{#2}
%			  }
%			}			  
}%



%------------------------------- just print #1 as code, custom format
\NewDocumentCommand{\cdrdcustom}{ o m }{%1=format code,2=cs
			% the o must match with incoming [ ]
 			{ #1
			  \detokenize{#2}
			  }
}	%


\str_new:N   \l_my_str

%------------------------------- just print #1 as code, section format
\NewDocumentCommand{\cdrdsection}{ O{} m }{%1=format code,2=cs
			% the o must match with incoming [ ]
%%%			\tl_set:Nn \l_my_tl { #2 }
%%%%				\regex_replace_all:nnN { (\c{[A-Za-z]*}) } { \cs_to_str:N \0 } \l_my_tl
%%%				\regex_replace_all:nnN { cc } { } \l_my_tl
%%%%%		\tl_to_str:n { \l_my_tl }
%%%			\str_set:NV \l_my_str  \l_my_tl 
%%%			\str_replace_all:Nnn 
%%%															\l_my_str 
%%%															{ ^^^^005c } 
%%%															{ xx }
%%%%															{ \c_backslash_str } 
%%%%															{ \c_empty_tl }
%%%%				\regex_replace_all:nnN { \\ } { \textbackslash ~  } \l_my_tl
%%%%%					\tl_replace_all:Nnn	
%%%%%															\l_my_tl 
%%%%%															{ \ }	
%%%%%															{ \textbackslash ~  }		
%%%				%				\c{[A-Za-z]*} = cs
% 			{ 
			  \section{\textbackslash \detokenize{#2} \enspace -- \enspace #1}
			  
			  \label{sec:#2}

%			  \section{ \tl_use:N \l_my_tl }
%						\S \tl_use:N \l_my_tl
%%		00 y 00 \tl_use:N \l_my_tl 00 y 00
%		      \section{ \str_use:N \l_my_str }
%%%		      >> \str_use:N \l_my_str <<
%			  }
}	%



%------------------------------- just print #1 as code, quotation format
\NewDocumentCommand{\cdrdquote}{ o m }{%1=format code,2=cs
			% the o must match with incoming [ ]
			\begin{quotation}
 			{
			  \cdrdplain{#2}
			  }
     \end{quotation}
}	%

%\newsavebox{\LstBox}
%
%\NewDocumentEnvironment { lcenv } { +b }
%{
%	\begin{lrbox}{\LstBox}
%	\begin{latexcode} #1 \end{latexcode} 
%	\end{lrbox}
%	}
%{}

%------------------------------- just print #1 as code, listing format
\NewDocumentCommand{\cdrdlisting}{ O{} m }{%1=format code,2=cs
			% the o must match with incoming [ ]
%			\begin { lcenv }
%			
%			\detokenize{#2} 
%				 
%     \end { lcenv }
%     
%     \usebox{LstBox}

	\begin{latexcode}[escapechar=Δ]
%	Δ\ \parΔ 
	#2
	Δ\ \parΔ
	Δ\Δend{latexcodex}
%			#2
}	%







\ExplSyntaxOff


%-----------------------
%latexcode env from doctools package:
\usepackage{listings}

%%% listings
\colorlet{docxstringcolor}{green!40!black!100}
\colorlet{docxcommentcolor}{green!50!black!100}
\colorlet{docxnumbercolor}{white!50!black!100}
\definecolor{docxkeywordcolor}{rgb}{0,0.35,1.0}
\colorlet{docxdemoxbackcolor}{blue!3}%white}
\definecolor{docxrulecolor}{rgb}{0.5,0.5,0.5}
\lstdefinestyle{lstStyleDefault}{
%%% appearance
   ,basicstyle=\small\ttfamily % Standardschrift
%%%  Space and placement
   ,floatplacement=tbp    % is used as float place specifier
   ,aboveskip=\medskipamount % define the space above and
   ,belowskip=\medskipamount % below displayed listings.
   ,lineskip=0pt          % specifies additional space between lines in listings.
   ,boxpos=c              % c,b,t
%%% The printed range
   ,showlines=false       % prints empty lines at the end of listings
%%% characters
   ,extendedchars=true   % allows or prohibits extended characters
                         % in listings, that means (national)
                         % characters of codes 128-255.
   ,upquote=true         % determines printing of quotes
   ,tabsize=2,           % chars of tab
   ,showtabs=false       % do not show tabs
   ,showspaces=false     % do not show spaces
   ,showstringspaces=false % do not show blank spaces in string
%%% Line numbers
   ,numbers=none         % left, right, none
%%% Captions
   ,numberbychapter=true %
   ,captionpos=b         % t,b
   ,abovecaptionskip=\smallskipamount % the vertical space respectively above
   ,belowcaptionskip=\smallskipamount % or below each caption
%%% Margins and line shape
   ,linewidth=\linewidth % defines the base line width for listings.
   ,xleftmargin=0pt      % extra margins
   ,xrightmargin=0pt     %
   ,resetmargins=false   % indention from list environments like enumerate
                         % or itemize is reset, i.e. not used.
   ,breaklines=true      % line breaking of long lines.
   ,breakatwhitespace=false % allows line breaks only at white space.
   ,breakindent=0pt     % is the indention of the second, third, ...
                         % line of broken lines.
   ,breakautoindent=true % apply intendation
   ,columns=flexible     %
   ,keepspaces=true      %
}

\lstset{style=lstStyleDefault}

\lstdefinestyle{lstDocStyleBase}{
%%% base style
   ,style=lstStyleDefault
%%% appearance
   ,commentstyle=\slshape
%%% Line numbers
   ,numbers=left         % left, right, none
   ,stepnumber=1         % seperation between numbers
   ,numberfirstline=false % number first line always
   ,numberstyle=\tiny\color{docxnumbercolor}    % style of numbers
   ,numbersep=5pt        % distance to text
   ,numberblanklines=true %
%%% language
   ,language = [LaTeX]TeX
%%% commands
   % LaTeX programming
   ,moretexcs={setlength,usepackage,newcommand,renewcommand,providecommand,RequirePackage,SelectInputMappings,ifpdftex,ifpdfoutput,AtBeginEnvironment,ProvidesPackage},
   % other commands
   ,moretexcs={maketitle,text,includegraphics,chapter,section,subsection,
     subsubsection,paragraph,textmu,enquote,blockquote,ding,mathds,ifcsdef,Bra,Ket,Braket,subcaption,lettrine,mdfsetup,captionof,listoffigures,listoftables,tableofcontents,appendix}
   % tables
   ,moretexcs={newcolumntype,rowfont,taburowcolors,rowcolor,rowcolors,bottomrule,
     toprule,midrule,}
   % hyperref
   ,moretexcs={hypersetup}
   % glossaries
   ,moretexcs={gls,printglossary,glsadd,newglossaryentry,newacronym}
   % Koma
   ,moretexcs={mainmatter,frontmatter,geometry,KOMAoptions,setkomafont,addtokomafont}
   % SI, unit
   ,moretexcs={si,SI,sisetup,unit,unitfrac,micro}
   % biblatex package
   ,moretexcs={newblock,ExecuteBibliographyOptions,addbibresource}
   % math packages
   ,moretexcs={operatorname,frac,sfrac,dfrac,DeclareMathOperator,mathcal,underset}
   % demo package
   ,moretexcs={democodefile,package,cs,command,env,DemoError,PrintDemo}
   % tablestyles
   ,moretexcs={theadstart,tbody,tsubheadstart,tsubhead,tend}
   % code section package
   ,moretexcs={DefineCodeSection,SetCodeSection,BeginCodeSection,
     EndCodeSection}
   % template tools package
   ,moretexcs={IfDefined,IfUndefined,IfElseDefined,IfElseUndefined,IfMultDefined,IfNotDraft,IfNotDraftElse,IfDraft,IfPackageLoaded,IfElsePackageLoaded,IfPackageNotLoaded,IfPackagesLoaded,IfPackagesNotLoaded,ExecuteAfterPackage,ExecuteBeforePackage,IfTikzLibraryLoaded,IfColumntypeDefined,IfColumntypesDefined,IfColorDefined,IfColorsDefined,IfMathVersionDefined,SetTemplateDefinition,UseDefinition,IfFileExists,iflanguage}
   % tablestyles
   ,moretexcs={setuptablefontsize,tablefontsize,setuptablestyle,tablestyle,  setuptablecolor,tablecolor,disablealternatecolors,   tablealtcolored,tbegin,tbody,tend,thead, theadstart,tsubheadstart,tsubhead,theadrow,tsubheadrow,resettablestyle,theadend,tsubheadend,tableitemize,PreserveBackslash}
   % todonotes
   ,moretexcs={todo,missingfigure}
   % listings
   ,moretexcs={lstloadlanguages,lstdefinestyle,lstset}
   % index
   ,moretexcs={indexsetup}
   % glossaries
   ,moretexcs={newglossarystyle,glossarystyle,deftranslation,newglossary}
   % tikz
   ,moretexcs={usetikzlibrary}
   % color
   ,moretexcs={definecolor,colorlet}
   % caption
   ,moretexcs={captionsetup,DeclareCaptionStyle}
   % floatrow
   ,moretexcs={floatsetup}
   % doc.sty
   ,moretexcs={EnableCrossrefs,DisableCrossrefs,PageIndex,CodelineIndex,CodelineNumbered}
   % refereces
   ,moretexcs={cref,Cref,vref,eqnref,figref,tabref,secref,chapref}
}

\lstdefinestyle{lstDemoStyleLaTeXCode}{ %
%%% base style
   ,style=lstDocStyleBase
%%% Line numbers
   ,numbers=none         % left, right, none
%%% colors
   ,stringstyle=\color{docxstringcolor}
   ,keywordstyle=\color{docxkeywordcolor}
   ,commentstyle=\color{docxcommentcolor}
   ,backgroundcolor=\color{docxdemoxbackcolor}
   ,rulecolor=\color{docxrulecolor}
%%% frame
   ,frame=single         % none, leftline, topline, bottomline, lines
                         % single, shadowbox
   ,framesep=3pt
   ,rulesep=2pt          % control the space between frame and listing
                         % and between double rules.
   ,framerule=0.4pt      % controls the width of the rules.
}

%\colorlet{docxcodexbackcolor}{gray!5}
%\colorlet{docxcodexkeywordcolor}{black}
%\colorlet{docxcodexcommentcolor}{black!60}

\lstdefinestyle{lstDocStyleLaTeXCode}{%
%%% base style
   ,style=lstDocStyleBase
%%% colors
   ,stringstyle=\color{docxstringcolor}
   ,keywordstyle=\color{docxcodexkeywordcolor} %
   ,commentstyle=\color{docxcodexcommentcolor}
   ,backgroundcolor=\color{docxcodexbackcolor}
   ,rulecolor=\color{docxrulecolor}
%%% frame
   ,frame=none         % none, leftline, topline, bottomline, lines
                         % single, shadowbox
   ,framesep=3pt
   ,rulesep=2pt          % control the space between frame and listing
                         % and between double rules.
   ,framerule=0.4pt      % controls the width of the rules.
%%% numbers
   ,firstnumber=last
}

\lstloadlanguages{[LaTeX]TeX}

%%% environment code examples.
\lstnewenvironment{latexcode}{% 
\bigskip\lstset{style=lstDemoStyleLaTeXCode}\ignorespaces}{\ignorespacesafterend}


\newcommand\creditlatenv{%
{\par\color{brown}\hfill \scriptsize [\textsf{\textbf{latexcode}} env from \textsc{doctools}\textsuperscript{2012} package, adapted]}%
}

\usepackage{etoolbox}
\AtEndEnvironment{latexcode}{\creditlatenv}

%------------------------------------------

\newfontface\fsemi{Noto Serif CJK JP}
\usepackage{ruby}
\newcommand{\defaultrubysep}{0.25ex}
\renewcommand{\rubysep}{\defaultrubysep}
\title{Meta CS}
\author{{\fsemi \ruby{\textcolor{brown!75!green}{\Huge 蝉
}}{せみ}}\\ \small `Cicada'}
\date{19 Apr 2021}


%------------------------------------------
\begin{document}
\maketitle
\begin{abstract}
\noindent\LaTeX\ commands for describing \LaTeX\ commands and switches, providing  \begin{inparaenum}[\itshape (a)]\item somewhat customisable argument delimiters, \margv{}, \oargv{}; \item different levels of emphasis, \cs{\command}, \cdrd{\command} and  \codedetok{\command}; and \item the ability to print and run commands: \cdr{\textit{text}}\end{inparaenum}.

\bigskip\ack
\end{abstract}
\myrulesep

\tableofcontents
%\lstlistoflistings
\myrulesep

\section{Control Sequence Meta Commands}\label{sec:meta}
\ 
\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
\bfseries Meta command & \bfseries Result \\
\hline
\cs{\cs}\marg{macro-name} & \cs{\test} \\
\cs{\marg}\marg{mandatory argument} & \marg{test} \\
\cs{\margv}\marg{mandatory argument value} & \margv{test} \\
\cs{\oarg}\marg{optional argument} & \oarg{test} \\
\cs{\oargv}\marg{optional argument value} & \oargv{test} \\
\cs{\meta}\marg{meta value} & \meta{test} \\
\hline
\end{tabular}

\bigskip
\cdrd[format=section][run a switch]{cc}
%\label{sec:cs}
Run \#1 as the control sequence \textbackslash\#1

\cs{\cc}\marg{no-slash cs-name}: run the zero-argument command (switch): \textbackslash\#1

The code
\begin{quotation}
\{ \cs{\cc}\margv{itshape}\cs{\cc}\margv{large} 123 \}
\end{quotation}

produces

\begin{quotation}
{\cc{itshape}\cc{large} 123 }
\end{quotation}

%Back to
%
%\cs{\cc}\margv{normalfont} \cs{\cc}\margv{normalsize} 

%\cc{normalfont} \cc{normalsize} 123

\bigskip
\cdrd[format=section][run a 1-argument command]{cd}
%\label{sec:cd}
Run as \textbackslash\#1\{\#2\}

\cs{\cd}\marg{cs-name}\marg{argument} : run the one-argument command: \textbackslash\#1\{\#2\}

\begin{quotation}
\begin{tabular}{ll}
Command & \cs{\cd}\margv{textit}\margv{Sample} \\
%resolves to & \mcsv{textit}{}{Sample}{}{} \\
resolves to & \cs{\textit}\margv{Sample} \\
which produces & \cd{textit}{Sample} \\
\end{tabular}
\end{quotation}

\bigskip
A command can be demonstrated inline (using \css{cdr}), like so: \\ \cdr{\cd{textit}{Sample}}.

A command can also be demonstated in display mode (using \css{cdrq}), like so: \cdrq{\cd{textit}{Sample}} 
For \css{cdr}, see \S \ref{sec:cdr}, and for \css{cdrq}, see \S \ref{sec:cdrq}.


\bigskip
\cd{c}{c} \cd{textsc}{Sample}\cd{textsuperscript}{squared} $\cc{pi}$

\begin{quotation}
\begin{tabular}{ll}
If & \cdr{$\cc{pi}$} \\
and & \cdr{$\pi$} \\
therefore & \cdrd{$\cc{pi}$} $\equiv$ \cdrd{$\pi$} \\
\end{tabular}
\end{quotation}

\cdr{\cd{textsc}{Sample}\cd{textsuperscript}{squared}}

x x x x x x x x x x x x x x x x x x x x x \cdr{\cd{textsc}{Sample}\cd{textsuperscript}{squared}} x x x x x x x x x x x x x x x 


\bigskip
%\cdrd[\bfseries\Huge\color{red}]{\cm}
\cdrd[format=head]{\cm} $\uparrow$ formatted as a header

\cdrd[format=custom][\bfseries\Huge\color{red}]{\cm==}$\leftarrow$ a custom format


\cdrd[format=section][inline maths]{cm}
%\label{sec:cm}

\cs{\cm}\marg{inline maths}: \cm{\frac{\pi^2}{2}}

\bigskip
\cdrd[format=section][display maths]{cmd}
%\label{sec:cmd}

\cs{\cmd}\marg{display maths}: \cmd{e=mc^2}



\begin{quotation}
\begin{tabular}{ll}
If & \cdr{\cm{\frac{\pi^2}{2}}} \\
and & \cdr{$\frac{\pi^2}{2}$} \\
therefore & \cdrd{\cm{\frac{\pi^2}{2}}} $\equiv$ \cdrd{$\frac{\pi^2}{2}$} \\
\end{tabular}
\end{quotation}

More generally, \cdrd{\cm{...}} does \cdrd{$...$}, and \cdrd{\cmd{...}} does \cdrd{\[...\]}.

%\cs{\itshape} 
%\cs{\textit}\marg{text}
%\css{textit}\marg{text}

\bigskip
\cdrd[format=section][add a \textbackslash]{css}
%\label{sec:css}

\cs{\css}: adds a \textbackslash : \cdr{\css{abc}}

\cs{\css}\margv{makebox}\cs{\oargcss}\margv{width}\cs{\margcss}\margv{text}

produces

\css{makebox}\oargcss{width}\margcss{text}

:: \mcs{makebox}{width}{text}{}{} :: same output using \cdrd{mcs{}{}{}{}{}}

e.g., \css{makebox}\oargvcss{4cm}\margvcss{The cat sat on the mat.}

Using \cdrd{\mcsv{}{}{}{}{}}, where the second argument is the option:

\mcsv{makebox}{4cm}{The cat sat on the mat.}{}{}


\bigskip
\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
Unemphasised \bfseries Meta command & \bfseries Result \\
\hline
\cs{\css}\marg{cs-name} & \cdr{\css{test}} \\
\cs{\margcss}\marg{mandatory argument} & \margcss{test} \\
\cs{\margvcss}\marg{mandatory argument value} & \margvcss{test} \\
\cs{\oargcss}\marg{optional argument} & \oargcss{test} \\
\cs{\oargvcss}\marg{optional argument value} & \oargvcss{test} \\
\cs{\meta}\marg{meta value} & \meta{test} \\
\hline
\end{tabular}



\bigskip
\cdrd[format=section][show and run]{cssom etc}
%\label{sec:css}

\cs{\cssom}: show and run command+opt+arg

\cssom{makebox}{4cm}{The cat sat on the mat.}

Using \cs{cdr}:

\cdr{\cssom{makebox}{4cm}{The cat sat on the mat.}}

\bigskip
\cdrd{\cssm}

\cs{\cssm}: show and run command+arg

\cssm{textit}{Some text}

\cssm{fbox}{This is framed text.}

\bigskip
\cdrd{\cssmm}

\cs{\cssmm}: show and run command+arg+arg

\cssmm{textcolor}{red}{This is red.}

\bigskip
\cdrd{\cssmmm}

\cs{\cssmmm}: show and run command+arg+arg+arg

\cssmmm{fcolorbox}{brown}{blue!20}{Some text in a framed box.}

\bigskip
\cdrd[format=section][generic print and run]{cdr}
%\label{sec:cdr}

Print \textbackslash \#1 inline, and run \textbackslash \#1.


\bigskip
\cdrd[format=section][print in quotation and run]{cdrq}
%\label{sec:cdrq}

Print \textbackslash \#1 in display format, and run \textbackslash \#1.



\bigskip
\cdrd[format=section][print]{cdrd}
%\label{sec:cdrd}

Print \textbackslash \#1 inline. 

This command takes options.

\textsc{Special Case:} When option \oargv{format=section} is active, and a second option \oarg{descriptive text} is specified (this will become the underlying sub-macro's argument \#1), and the argument (will become \#2) has no backslash (only \#2, not \textbackslash \#2), the command prints \codegeneral{\textbackslash \#2 -- \#1} as the section heading (and therefore table of contents) and sets the label as \codegeneral{\css{label\{sec:\#2\}}}.

The heading for this section was produced with \cdrd[format=quote]{\cdrd[format=section][print]{cdrd}}

\bigskip
List of \codegeneral{format=} options:

\begin{quotation}
\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
Option & Example \\
\hline
\meta{None} & \cdr{\cdrd{\xyz}}\\
head & \cdr{\cdrd[format=head]{\xyz}}\\
custom & \cdr{\cdrd[format=custom][\bfseries\tiny\sffamily]{\xyz}}\\
section & See outside the table. \\
subsection & Similar to section \\
quote & \parbox{4.5in}{\cdrd{\cdrd[format=quote]{xyz demo This is a quote}}: \\ See outside the table.} \\
listing & <in development> \\
general & \cdr{\cdrd[format=general]{[format=xyz]}}\\
detok & \cdr{\cdrd[format=detok]{\xyz}}\\
\hline
\end{tabular}
%\end{quotation}

\bigskip
The \codegeneral{[format=section]} output does not fit in a table. 

\cdr{\cdrd[format=section]{xyz demo}}

\noindent Note that the label for \S\ref{sec:xyz demo} has been set as \begin{quote}\cdrd{\label{sec:xyz demo}}\end{quote} that is, with a space between \texttt{xyz} and \texttt{demo}.
\end{quotation}


\cdrd[format=quote]{xyz demo This is a quote}

xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx 

%\cdrd[format=listing]{xyz demo \itshape This is (not) a listing}

Calling the listing environment from inside a command doesn't quite work:

\cdrdlisting{xxx
} 

qwerty: The listing environment never closes when used inside a command.

abc
\end{latexcode}


So for a listing, use the \codedetok{\begin{latexcode} . . . \end{latexcode}} environment directly, with those commands on separate lines: 

\begin{latexcode} 
xxx 
\end{latexcode}

\bigskip
The \cdrd{\cdr} command can take abitrary code.

\textbf{Example start >>>>}

\cdr{
\bigskip
\begin{quotation}
\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
Option & Example \\
\hline
None & \cdr{\cdrd{\xyz}}\\
Header & \cdr{\cdrd[format=head]{\xyz}}\\
Custom & \cdr{\cdrd[format=custom][\bfseries\tiny\sffamily]{\xyz}}\\
Section & See outside the table. \\
\hline
\end{tabular}
\end{quotation}
}

\textbf{<<<< Example end}

%\textbf{xxxx\newpage xxxx}

\bigskip
\section{Empty arguments}
\label{sec:empty}


%\cs{} %: Note \cdr{\cs{{}}}

\marg{}

\noindent\oarg{}


\noindent\margv{}

\noindent\oargv{}


\bigskip
\section{Formatting}
\label{sec:formatting}

Delimiters can be reformatted to some extent.

\begin{quotation}
\marg{delimiter test}

\renewcommand\margdelimleftchar{+++}
\cdrd{\renewcommand\margdelimleftchar{+++}}

\marg{delimiter test}

\renewcommand\margdelimrightformat{\itshape\Huge}
\cdrd{\renewcommand\margdelimrightformat{\itshape\Huge}}

\marg{delimiter test}

\margreset
\cdrd{\margreset}

\marg{delimiter test}
\end{quotation}

\bigskip
Alternatively, just type the new code in the command definition directly.

%===
%
%\oarg{delimiter test}
%
%\renewcommand\oargdelimleftchar{+++}
%\cdrd{\renewcommand\oargdelimleftchar{+++}}
%
%\oarg{delimiter test}
%
%\renewcommand\oargdelimrightformat{\itshape\Huge}
%\cdrd{\renewcommand\oargdelimrightformat{\itshape\Huge}}
%
%\oarg{delimiter test}
%
%\oargreset
%\cdrd{\oargreset}
%
%\oarg{delimiter test}

\bigskip
List of some customisable components.

\textbf{marg left}

\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
\bfseries Item & \bfseries Default value \\
\hline
\cdrd{\margdelimformat} &
\codedetok{\ttfamily\large\color{red}} \\
\cdrd{\margdelimleftformat} &
\codedetok{\margdelimformat} \\
\cdrd{\margdelimleftchar} &
\codedetok{\c_left_brace_str} \\
\cdrd{\margdelimleft} &
\parbox{2in}{\{\\ 
\codedetok{\margdelimleftformat}\\
\codedetok{\margdelimleftchar}\\
\}} 
\\
\hline
\end{tabular}

\bigskip
\textbf{marg right}

\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
\bfseries Item & \bfseries Default value \\
\hline
\cdrd{\margdelimformat} &
\codedetok{\ttfamily\large\color{red}} \\
\cdrd{\margdelimrightformat} &
\codedetok{\margdelimformat} \\
\cdrd{\margdelimrightchar} &
\codedetok{\c_right_brace_str} \\
\cdrd{\margdelimright} &
\parbox{2in}{\{\\ 
\codedetok{\margdelimrightformat}\\
\codedetok{\margdelimrightchar}\\
\}} 
\\
\hline
\end{tabular}


\textbf{oarg left}

\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
\bfseries Item & \bfseries Default value \\
\hline
\cdrd{\oargdelimformat} &
\codedetok{\ttfamily\large} \\
\cdrd{\oargdelimleftformat} &
\codedetok{\oargdelimformat} \\
\cdrd{\oargdelimleftchar} &
\codedetok{[} \\
\cdrd{\oargdelimleft} &
\parbox{2in}{\{\\ 
\codedetok{\oargdelimleftformat}\\
\codedetok{\oargdelimleftchar}\\
\}} 
\\
\hline
\end{tabular}

\bigskip
\textbf{oarg right}

\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
\bfseries Item & \bfseries Default value \\
\hline
\cdrd{\oargdelimformat} &
\codedetok{\ttfamily\large} \\
\cdrd{\oargdelimrightformat} &
\codedetok{\oargdelimformat} \\
\cdrd{\oargdelimrightchar} &
\codedetok{]} \\
\cdrd{\oargdelimright} &
\parbox{2in}{\{\\ 
\codedetok{\oargdelimrightformat}\\
\codedetok{\oargdelimrightchar}\\
\}} 
\\
\hline
\end{tabular}




\hrulefill

{ group

Current font text

\setmainfont{Noto Serif} 
\cdrd{\setmainfont{Noto Serif} }

Current font text
xxx

\addfontfeature{Colour=brown,Scale=2} 
\cdrd{\addfontfeature{Colour=brown,Scale=2} }

xxx

} endgroup
xxx

\section{Listing using latexcode environment}
\label{sec:latexcode}

%[caption={Example of latexcode environment}	]
\begin{latexcode}[caption={Example of latexcode environment},title=Demo code,	]
		\documentclass{article}
		\usepackage{doctools}
		\begin{document}
		\begin{latexcode}
		(code)		% comment
\cdr{
\bigskip
\begin{quotation}
\begin{tabular}{ll}
\rowcolor{\mytheadcolour}
Option & Example \\
\hline
None & \cdr{\cdrd{\xyz}}\\
Header & \cdr{\cdrd[format=head]{\xyz}}\\
Custom & \cdr{\cdrd[format=custom][\bfseries\tiny\sffamily]{\xyz}}\\
Section & See outside the table. \\
\hline
\end{tabular}
\end{quotation}
}
		
		\ end{latexcode}%<--- note the space
		\end{document}
\end{latexcode}

\myrulesep

\end{document}